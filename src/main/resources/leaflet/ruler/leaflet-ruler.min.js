(function(a,b){"function"===typeof define&&define.amd?define(["leaflet"],a):"object"===typeof exports&&(module.exports=a(require("leaflet")));"undefined"!==typeof b&&b.L&&(b.L.Ruler=a(L))})(function(a){a.Control.Ruler=a.Control.extend({options:{position:"topright",circleMarker:{color:"red",radius:2},lineStyle:{color:"red",dashArray:"1,6"},lengthUnit:{display:"km",decimal:2,factor:null,label:"Distance:"},angleUnit:{display:"&deg;",decimal:2,factor:null,label:"Bearing:"}},onAdd:function(b){this._map=
b;this._container=a.DomUtil.create("div","leaflet-bar");this._container.classList.add("leaflet-ruler");a.DomEvent.disableClickPropagation(this._container);a.DomEvent.on(this._container,"click",this._toggleMeasure,this);this._choice=!1;this._defaultCursor=this._map._container.style.cursor;this._allLayers=a.layerGroup();return this._container},onRemove:function(){a.DomEvent.off(this._container,"click",this._toggleMeasure,this)},_toggleMeasure:function(){this._choice=!this._choice;this._clickedLatLong=
null;this._clickedPoints=[];this._totalLength=0;this._choice?(this._map.doubleClickZoom.disable(),a.DomEvent.on(this._map._container,"keydown",this._escape,this),a.DomEvent.on(this._map._container,"dblclick",this._closePath,this),this._container.classList.add("leaflet-ruler-clicked"),this._clickCount=0,this._tempLine=a.featureGroup().addTo(this._allLayers),this._tempPoint=a.featureGroup().addTo(this._allLayers),this._pointLayer=a.featureGroup().addTo(this._allLayers),this._polylineLayer=a.featureGroup().addTo(this._allLayers),
this._allLayers.addTo(this._map),this._map._container.style.cursor="crosshair",this._map.on("click",this._clicked,this),this._map.on("mousemove",this._moving,this)):(this._map.doubleClickZoom.enable(),a.DomEvent.off(this._map._container,"keydown",this._escape,this),a.DomEvent.off(this._map._container,"dblclick",this._closePath,this),this._container.classList.remove("leaflet-ruler-clicked"),this._map.removeLayer(this._allLayers),this._allLayers=a.layerGroup(),this._map._container.style.cursor=this._defaultCursor,
this._map.off("click",this._clicked,this),this._map.off("mousemove",this._moving,this))},_clicked:function(b){this._clickedLatLong=b.latlng;this._clickedPoints.push(this._clickedLatLong);a.circleMarker(this._clickedLatLong,this.options.circleMarker).addTo(this._pointLayer);0<this._clickCount&&!b.latlng.equals(this._clickedPoints[this._clickedPoints.length-2])&&(this._movingLatLong&&a.polyline([this._clickedPoints[this._clickCount-1],this._movingLatLong],this.options.lineStyle).addTo(this._polylineLayer),
this._totalLength+=this._result.Distance,b=1<this._clickCount?"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._totalLength.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display:"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+
"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._result.Distance.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display,a.circleMarker(this._clickedLatLong,this.options.circleMarker).bindTooltip(b,{permanent:!0,className:"result-tooltip"}).addTo(this._pointLayer).openTooltip());this._clickCount++},_moving:function(b){this._clickedLatLong&&(a.DomEvent.off(this._container,"click",this._toggleMeasure,this),this._movingLatLong=b.latlng,this._tempLine&&(this._map.removeLayer(this._tempLine),
this._map.removeLayer(this._tempPoint)),this._addedLength=0,this._tempLine=a.featureGroup(),this._tempPoint=a.featureGroup(),this._tempLine.addTo(this._map),this._tempPoint.addTo(this._map),this._calculateBearingAndDistance(),this._addedLength=this._result.Distance+this._totalLength,a.polyline([this._clickedLatLong,this._movingLatLong],this.options.lineStyle).addTo(this._tempLine),b=1<this._clickCount?"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+
"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._addedLength.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display+'<br><div class="plus-length">(+'+this._result.Distance.toFixed(this.options.lengthUnit.decimal)+")</div>":"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+
this._result.Distance.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display,a.circleMarker(this._movingLatLong,this.options.circleMarker).bindTooltip(b,{sticky:!0,offset:a.point(0,-40),className:"moving-tooltip"}).addTo(this._tempPoint).openTooltip())},_escape:function(a){27===a.keyCode&&(0<this._clickCount?this._closePath():(this._choice=!0,this._toggleMeasure()))},_calculateBearingAndDistance:function(){var a=this._clickedLatLong.lat,d=this._clickedLatLong.lng,e=this._movingLatLong.lat,
f=this._movingLatLong.lng,c=Math.PI/180,g=(this.options.angleUnit.factor?this.options.angleUnit.factor/2:180)/Math.PI*Math.atan2(Math.sin((f-d)*c)*Math.cos(e*c),Math.cos(a*c)*Math.sin(e*c)-Math.sin(a*c)*Math.cos(e*c)*Math.cos((f-d)*c));g+=0>g?this.options.angleUnit.factor?this.options.angleUnit.factor:360:0;var h=(e-a)*c;d=(f-d)*c;a=Math.sin(h/2)*Math.sin(h/2)+Math.cos(a*c)*Math.cos(e*c)*Math.sin(d/2)*Math.sin(d/2);this._result={Bearing:g,Distance:2*(this.options.lengthUnit.factor?6371*this.options.lengthUnit.factor:
6371)*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}},_closePath:function(){this._map.removeLayer(this._tempLine);this._map.removeLayer(this._tempPoint);this._choice=!1;a.DomEvent.on(this._container,"click",this._toggleMeasure,this);this._toggleMeasure()}});a.control.ruler=function(b){return new a.Control.Ruler(b)}},window);