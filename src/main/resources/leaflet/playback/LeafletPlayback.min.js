(function(b){if("function"===typeof define&&define.amd)define(["leaflet"],b);else if("object"===typeof module&&"object"===typeof module.exports){var a=require("leaflet");module.exports=b(a)}else{if("undefined"===typeof window.L)throw"Leaflet must be loaded first";b(window.L)}})(function(b){b.Playback=b.Playback||{};b.Playback.Util=b.Class.extend({statics:{DateStr:function(a){return(new Date(a)).toDateString()},TimeStr:function(a){var c=new Date(a),b=c.getHours(),e=c.getMinutes();c=c.getSeconds();
a/=1E3;a=(a-Math.floor(a)).toFixed(2).slice(1);var g="AM";11<b&&(b%=12,g="PM");0===b&&(b=12);10>e&&(e="0"+e);10>c&&(c="0"+c);return b+":"+e+":"+c+a+" "+g},ParseGPX:function(a){var c={type:"Feature",geometry:{type:"MultiPoint",coordinates:[]},properties:{time:[],speed:[],altitude:[]},bbox:[]};a=$.parseXML(a);a=$(a).find("trkpt");for(var b=0,e=a.length;b<e;b++){var g=a[b],h=parseFloat(g.getAttribute("lat")),k=parseFloat(g.getAttribute("lon")),l=$(g).find("time").text();g=$(g).find("ele").text();l=(new Date(l)).getTime();
g=parseFloat(g);var f=c.properties.time,n=c.properties.altitude;c.geometry.coordinates.push([k,h]);f.push(l);n.push(g)}return c}}});b.Playback=b.Playback||{};b.Playback.MoveableMarker=b.Marker.extend({initialize:function(a,c,d){var e=c.marker||{};jQuery.isFunction(e)&&(e=e(d));b.Marker.prototype.initialize.call(this,a,e);this.popupContent="";this.feature=d;e.getPopup&&(this.popupContent=e.getPopup(d));c.popups&&this.bindPopup(this.getPopupContent()+a.toString());c.labels&&(this.bindLabel?this.bindLabel(this.getPopupContent()):
console.log("Label binding requires leaflet-label (https://github.com/Leaflet/Leaflet.label)"))},getPopupContent:function(){return""!==this.popupContent?"<b>"+this.popupContent+"</b><br/>":""},move:function(a,c){b.DomUtil.TRANSITION&&(this._icon&&(this._icon.style[b.DomUtil.TRANSITION]="all "+c+"ms linear",this._popup&&this._popup._wrapper&&(this._popup._wrapper.style[b.DomUtil.TRANSITION]="all "+c+"ms linear")),this._shadow&&(this._shadow.style[b.DomUtil.TRANSITION]="all "+c+"ms linear"));this.setLatLng(a);
this._popup&&this._popup.setContent(this.getPopupContent()+this._latlng.toString())},_old__setPos:b.Marker.prototype._setPos,_updateImg:function(a,c,d){c=b.point(d).divideBy(2)._subtract(b.point(c));d=" translate("+-c.x+"px, "+-c.y+"px)";d+=" rotate("+this.options.iconAngle+"deg)";d+=" translate("+c.x+"px, "+c.y+"px)";a.style[b.DomUtil.TRANSFORM]+=d},setIconAngle:function(a){this.options.iconAngle=a;this._map&&this.update()},_setPos:function(a){this._icon&&(this._icon.style[b.DomUtil.TRANSFORM]="");
this._shadow&&(this._shadow.style[b.DomUtil.TRANSFORM]="");this._old__setPos.apply(this,[a]);if(this.options.iconAngle){a=this.options.icon.options.iconAnchor;var c=this.options.icon.options.iconSize;if(this._icon){var d=this._icon;this._updateImg(d,a,c)}this._shadow&&(c=this.options.icon.options.shadowSize,d=this._shadow,this._updateImg(d,a,c))}}});b.Playback=b.Playback||{};b.Playback.Track=b.Class.extend({initialize:function(a,c){c=c||{};var b=c.tickLen||250;this._staleTime=c.staleTime||36E5;this._fadeMarkersWhenStale=
c.fadeMarkersWhenStale||!1;this._geoJSON=a;this._tickLen=b;this._ticks=[];this._marker=null;this._orientations=[];var e=a.properties.time;this._orientIcon=c.orientIcons;var g=a.geometry.coordinates,h=g[0],k=g[1],l=e[0],f=l,n=e[1],m=f%b;if(1===e.length)0!==m&&(f+=b-m),this._ticks[f]=g[0],this._orientations[f]=0,this._endTime=this._startTime=f;else{0!==m?(m=b-m,f+=m,this._ticks[f]=this._interpolatePoint(h,k,m/(n-l))):this._ticks[f]=h;this._orientations[f]=this._directionOfPoint(h,k);a=this._orientations[f];
this._startTime=f;for(f+=b;f<n;){var q=(f-l)/(n-l);this._ticks[f]=this._interpolatePoint(h,k,q);this._orientations[f]=this._directionOfPoint(h,k);a=this._orientations[f];f+=b}for(var p=1,r=g.length;p<r;p++)for(h=g[p],k=g[p+1],f=l=e[p],n=e[p+1],m=f%b,0!==m&&n?(m=b-m,q=m/(n-l),f+=m,this._ticks[f]=this._interpolatePoint(h,k,q)):this._ticks[f]=h,k?(this._orientations[f]=this._directionOfPoint(h,k),a=this._orientations[f]):this._orientations[f]=a,f+=b;f<n;)q=(f-l)/(n-l),this._ticks[f]=n-l>c.maxInterpolationTime?
h:this._interpolatePoint(h,k,q),k?(this._orientations[f]=this._directionOfPoint(h,k),a=this._orientations[f]):this._orientations[f]=a,f+=b;this._endTime=f-b;this._lastTick=this._ticks[this._endTime]}},_interpolatePoint:function(a,c,b){try{var d=[c[0]-a[0],c[1]-a[1]],g=[d[0]*b,d[1]*b];return[a[0]+g[0],a[1]+g[1]]}catch(h){console.log("err: cant interpolate a point"),console.log(["start",a]),console.log(["end",c]),console.log(["ratio",b])}},_directionOfPoint:function(a,c){return this._getBearing(a[1],
a[0],c[1],c[0])},_getBearing:function(a,c,b,e){a=this._radians(a);c=this._radians(c);b=this._radians(b);e=this._radians(e);c=e-c;a=Math.log(Math.tan(b/2+Math.PI/4)/Math.tan(a/2+Math.PI/4));Math.abs(c)>Math.PI&&(c=0<c?-(2*Math.PI-c):2*Math.PI+c);return(this._degrees(Math.atan2(c,a))+360)%360},_radians:function(a){return Math.PI/180*a},_degrees:function(a){return 180/Math.PI*a},getFirstTick:function(){return this._ticks[this._startTime]},getLastTick:function(){return this._ticks[this._endTime]},getStartTime:function(){return this._startTime},
getEndTime:function(){return this._endTime},getTickMultiPoint:function(){for(var a=this.getStartTime(),b=this.getEndTime(),d=[],e=[];a<=b;)e.push(a),d.push(this.tick(a)),a+=this._tickLen;return{type:"Feature",geometry:{type:"MultiPoint",coordinates:d},properties:{time:e}}},trackPresentAtTick:function(a){return a>=this._startTime},trackStaleAtTick:function(a){return this._endTime+this._staleTime<=a},tick:function(a){a>this._endTime&&(a=this._endTime);a<this._startTime&&(a=this._startTime);return this._ticks[a]},
courseAtTime:function(a){a>this._endTime&&(a=this._endTime);a<this._startTime&&(a=this._startTime);return this._orientations[a]},setMarker:function(a,c){var d;if(d=a?this.tick(a):this.getFirstTick()){d=new b.LatLng(d[1],d[0]);this._marker=new b.Playback.MoveableMarker(d,c,this._geoJSON);if(c.mouseOverCallback)this._marker.on("mouseover",c.mouseOverCallback);if(c.clickCallback)this._marker.on("click",c.clickCallback);this._fadeMarkersWhenStale&&!this.trackPresentAtTick(a)&&this._marker.setOpacity(0)}return this._marker},
moveMarker:function(a,b,d){this._marker&&(this._fadeMarkersWhenStale&&(this.trackPresentAtTick(d)?this._marker.setOpacity(1):this._marker.setOpacity(0),this.trackStaleAtTick(d)&&this._marker.setOpacity(.25)),this._orientIcon&&this._marker.setIconAngle(this.courseAtTime(d)),this._marker.move(a,b))},getMarker:function(){return this._marker}});b.Playback=b.Playback||{};b.Playback.TrackController=b.Class.extend({initialize:function(a,b,d){this.options=d||{};this._map=a;this._tracks=[];this.setTracks(b)},
clearTracks:function(){for(;0<this._tracks.length;){var a=this._tracks.pop().getMarker();a&&this._map.removeLayer(a)}},setTracks:function(a){this.clearTracks();this.addTracks(a)},addTracks:function(a){if(a)if(a instanceof Array)for(var b=0,d=a.length;b<d;b++)this.addTrack(a[b]);else this.addTrack(a)},addTrack:function(a,b){a&&(b=a.setMarker(b,this.options))&&(b.addTo(this._map),this._tracks.push(a))},tock:function(a,c){for(var d=0,e=this._tracks.length;d<e;d++){var g=this._tracks[d].tick(a);g=new b.LatLng(g[1],
g[0]);this._tracks[d].moveMarker(g,c,a)}},getStartTime:function(){var a=0;if(0<this._tracks.length){a=this._tracks[0].getStartTime();for(var b=1,d=this._tracks.length;b<d;b++){var e=this._tracks[b].getStartTime();e<a&&(a=e)}}return a},getEndTime:function(){var a=0;if(0<this._tracks.length){a=this._tracks[0].getEndTime();for(var b=1,d=this._tracks.length;b<d;b++){var e=this._tracks[b].getEndTime();e>a&&(a=e)}}return a},getTracks:function(){return this._tracks}});b.Playback=b.Playback||{};b.Playback.Clock=
b.Class.extend({initialize:function(a,c,d){this._trackController=a;this._callbacksArry=[];c&&this.addCallback(c);b.setOptions(this,d);this._speed=this.options.speed;this._tickLen=this.options.tickLen;this._cursor=a.getStartTime();this._transitionTime=this._tickLen/this._speed},_tick:function(a){a._cursor>a._trackController.getEndTime()?clearInterval(a._intervalID):(a._trackController.tock(a._cursor,a._transitionTime),a._callbacks(a._cursor),a._cursor+=a._tickLen)},_callbacks:function(a){for(var b=
this._callbacksArry,d=0,e=b.length;d<e;d++)b[d](a)},addCallback:function(a){this._callbacksArry.push(a)},start:function(){this._intervalID||(this._intervalID=window.setInterval(this._tick,this._transitionTime,this))},stop:function(){this._intervalID&&(window.clearInterval(this._intervalID),this._intervalID=null)},getSpeed:function(){return this._speed},isPlaying:function(){return this._intervalID?!0:!1},setSpeed:function(a){this._speed=a;this._transitionTime=this._tickLen/a;this._intervalID&&(this.stop(),
this.start())},setCursor:function(a){if(a=parseInt(a)){var b=a%this._tickLen;0!==b&&(a+=this._tickLen-b);this._cursor=a;this._trackController.tock(this._cursor,0);this._callbacks(this._cursor)}},getTime:function(){return this._cursor},getStartTime:function(){return this._trackController.getStartTime()},getEndTime:function(){return this._trackController.getEndTime()},getTickLen:function(){return this._tickLen}});b.Playback=b.Playback||{};b.Playback.TracksLayer=b.Class.extend({initialize:function(a,
c){c=c.layer||{};jQuery.isFunction(c)&&(c=c(feature));c.pointToLayer||(c.pointToLayer=function(a,c){return new b.CircleMarker(c,{radius:5})});this.layer=new b.GeoJSON(null,c);b.control.layers(null,{"GPS Tracks":this.layer},{collapsed:!1}).addTo(a)},clearLayer:function(){for(var a in this.layer._layers)this.layer.removeLayer(this.layer._layers[a])},addLayer:function(a){this.layer.addData(a)}});b.Playback=b.Playback||{};b.Playback.DateControl=b.Control.extend({options:{position:"bottomleft",dateFormatFn:b.Playback.Util.DateStr,
timeFormatFn:b.Playback.Util.TimeStr},initialize:function(a,c){b.setOptions(this,c);this.playback=a},onAdd:function(a){this._container=b.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var c=this;a=this.playback;var d=a.getTime(),e=b.DomUtil.create("div","datetimeControl",this._container);this._date=b.DomUtil.create("p","",e);this._time=b.DomUtil.create("p","",e);this._date.innerHTML=this.options.dateFormatFn(d);this._time.innerHTML=this.options.timeFormatFn(d);a.addCallback(function(a){c._date.innerHTML=
c.options.dateFormatFn(a);c._time.innerHTML=c.options.timeFormatFn(a)});return this._container}});b.Playback.PlayControl=b.Control.extend({options:{position:"bottomleft"},initialize:function(a){this.playback=a},onAdd:function(a){this._container=b.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var c=this,d=this.playback;d.setSpeed(100);a=b.DomUtil.create("div","playControl",this._container);this._button=b.DomUtil.create("button","",a);this._button.innerHTML="Play";a=
b.DomEvent.stopPropagation;b.DomEvent.on(this._button,"click",a).on(this._button,"mousedown",a).on(this._button,"dblclick",a).on(this._button,"click",b.DomEvent.preventDefault).on(this._button,"click",function(){d.isPlaying()?(d.stop(),c._button.innerHTML="Play"):(d.start(),c._button.innerHTML="Stop")},this);return this._container}});b.Playback.SliderControl=b.Control.extend({options:{position:"bottomleft"},initialize:function(a){this.playback=a},onAdd:function(a){function c(a){e.setCursor(Number(a.target.value))}
this._container=b.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var d=this,e=this.playback;this._slider=b.DomUtil.create("input","slider",this._container);this._slider.type="range";this._slider.min=e.getStartTime();this._slider.max=e.getEndTime();this._slider.value=e.getTime();var g=b.DomEvent.stopPropagation;b.DomEvent.on(this._slider,"click",g).on(this._slider,"mousedown",g).on(this._slider,"dblclick",g).on(this._slider,"click",b.DomEvent.preventDefault).on(this._slider,
"change",c,this).on(this._slider,"mousemove",c,this);e.addCallback(function(a){d._slider.value=a});a.on("playback:add_tracks",function(){d._slider.min=e.getStartTime();d._slider.max=e.getEndTime();d._slider.value=e.getTime()});return this._container}});b.Playback=b.Playback.Clock.extend({statics:{MoveableMarker:b.Playback.MoveableMarker,Track:b.Playback.Track,TrackController:b.Playback.TrackController,Clock:b.Playback.Clock,Util:b.Playback.Util,TracksLayer:b.Playback.TracksLayer,PlayControl:b.Playback.PlayControl,
DateControl:b.Playback.DateControl,SliderControl:b.Playback.SliderControl},options:{tickLen:250,speed:1,maxInterpolationTime:3E5,tracksLayer:!0,playControl:!1,dateControl:!1,sliderControl:!1,layer:{},marker:{}},initialize:function(a,c,d,e){b.setOptions(this,e);this._map=a;this._trackController=new b.Playback.TrackController(a,null,this.options);b.Playback.Clock.prototype.initialize.call(this,this._trackController,d,this.options);this.options.tracksLayer&&(this._tracksLayer=new b.Playback.TracksLayer(a,
e));this.setData(c);this.options.playControl&&(this.playControl=new b.Playback.PlayControl(this),this.playControl.addTo(a));this.options.sliderControl&&(this.sliderControl=new b.Playback.SliderControl(this),this.sliderControl.addTo(a));this.options.dateControl&&(this.dateControl=new b.Playback.DateControl(this,e),this.dateControl.addTo(a))},clearData:function(){this._trackController.clearTracks();this._tracksLayer&&this._tracksLayer.clearLayer()},setData:function(a){this.clearData();this.addData(a,
this.getTime());this.setCursor(this.getStartTime())},addData:function(a,c){if(a){if(a instanceof Array)for(var d=0,e=a.length;d<e;d++)this._trackController.addTrack(new b.Playback.Track(a[d],this.options),c);else this._trackController.addTrack(new b.Playback.Track(a,this.options),c);this._map.fire("playback:set:data");this.options.tracksLayer&&this._tracksLayer.addLayer(a)}},destroy:function(){this.clearData();this.playControl&&this._map.removeControl(this.playControl);this.sliderControl&&this._map.removeControl(this.sliderControl);
this.dateControl&&this._map.removeControl(this.dateControl)}});b.Map.addInitHook(function(){this.options.playback&&(this.playback=new b.Playback(this))});b.playback=function(a,c,d,e){return new b.Playback(a,c,d,e)};return b.Playback});