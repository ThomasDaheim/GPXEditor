L.Edit.PolyVerticesEdit.include({addHooks:function(){var a=this._poly;a instanceof L.Polygon||(a.options.fill=!1,a.options.editing&&(a.options.editing.fill=!1));a.setStyle(a.options.editing);if(this._poly._map&&(this._map=this._poly._map,this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup),this.options.lazyMode=!0,this.options.lazyMode))this._poly._map.on("mousemove",this._handleMouseOver,this)},removeHooks:function(){var a=this._poly;a.setStyle(a.options.original);a._map&&
(a._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this.options.lazyMode&&this._poly._map.off("mousemove",this._handleMouseOver,this))},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup);this._markers=[];var a=this._defaultShape(),b;if(!this.options.lazyMode){var d=0;for(b=a.length;d<b;d++){var c=this._createMarker(a[d],d);c.on("click",this._onMarkerClick,this);this._markers.push(c)}d=0;for(a=b-1;d<b;a=d++)if(0!==d||L.Polygon&&this._poly instanceof
L.Polygon)a=this._markers[a],c=this._markers[d],this._createMiddleMarker(a,c),this._updatePrevNext(a,c)}},_handleMouseOver:function(a){if(!this._dragging){for(var b,d=2E4,c=this._defaultShape(),e=1;e<c.length;e++){var f=this._map.latLngToLayerPoint(c[e-1]),g=this._map.latLngToLayerPoint(c[e]);f=L.LineUtil.pointToSegmentDistance(a.layerPoint,f,g);f<d&&(b=e,d=f)}e=c[b];if(null==this._nearMarker||this._nearMarker.getLatLng().lat!=e.lat||this._nearMarker.getLatLng().lng!=e.lng){this._markerGroup.clearLayers();
this._markers=[];for(e=b+3;e>b-3;e--)a=this._createMarker(c[e],e),null!=a&&(a.on("click",this._onMarkerClick,this),this._markers.push(a),e==b&&(this._nearMarker=a));b=this._markers.length;e=0;for(c=b-1;e<b;c=e++)if(0!==e||L.Polygon&&this._poly instanceof L.Polygon)c=this._markers[c],a=this._markers[e],this._createMiddleMarker(a,c),this._updatePrevNext(a,c)}}},_createMarker:function(a,b){if(null!=a){var d=new L.Marker.Touch(a,{draggable:!0,icon:this.options.icon});d._origLatLng=a;d._index=b;d.on("dragstart",
this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._fireEdit,this).on("touchmove",this._onTouchMove,this).on("touchend",this._fireEdit,this).on("MSPointerMove",this._onTouchMove,this).on("MSPointerUp",this._fireEdit,this);this._markerGroup.addLayer(d);return d}},_onMarkerDragStart:function(){this._poly.fire("editstart");this._dragging=!0},_spliceLatLngs:function(){var a=this._defaultShape(),b=[].splice.apply(a,arguments);this._poly._convertLatLngs(a,!0);this._poly.redraw();
return b},_removeMarker:function(a){var b=a._index;this._markerGroup.removeLayer(a);this._markers.splice(b,1);this._spliceLatLngs(b,1);this._updateIndexes(b,-1);a.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("touchmove",this._onMarkerDrag,this).off("touchend",this._fireEdit,this).off("click",this._onMarkerClick,this).off("MSPointerMove",this._onTouchMove,this).off("MSPointerUp",this._fireEdit,this)},_fireEdit:function(){this._poly.edited=
!0;this._poly.fire("edit");this._poly._map.fire(L.Draw.Event.EDITVERTEX,{layers:this._markerGroup,poly:this._poly});this._dragging=!1},_onMarkerDrag:function(a){var b=a.target,d=this._poly;L.extend(b._origLatLng,b._latlng);b._origLatLng.alt=null;b._middleLeft&&b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b));b._middleRight&&b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next));if(d.options.poly){var c=d._map._editTooltip;if(!d.options.poly.allowIntersection&&d.intersects()){var e=d.options.color;
d.setStyle({color:this.options.drawError.color});0!==L.version.indexOf("0.7")&&b.dragging._draggable._onUp(a);this._onMarkerClick(a);c&&c.updateContent({text:L.drawLocal.draw.handlers.polyline.error});setTimeout(function(){d.setStyle({color:e});c&&c.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext})},1E3)}}this._poly.redraw();this._poly.fire("editdrag")},_onMarkerClick:function(a){var b=L.Polygon&&this._poly instanceof L.Polygon?
4:3;a=a.target;this._defaultShape().length<b||(this._removeMarker(a),this._updatePrevNext(a._prev,a._next),a._middleLeft&&this._markerGroup.removeLayer(a._middleLeft),a._middleRight&&this._markerGroup.removeLayer(a._middleRight),a._prev&&a._next?this._createMiddleMarker(a._prev,a._next):a._prev?a._next||(a._prev._middleRight=null):a._next._middleLeft=null,this._fireEdit())},_onTouchMove:function(a){var b=this._map.mouseEventToLayerPoint(a.originalEvent.touches[0]);b=this._map.layerPointToLatLng(b);
a=a.target;L.extend(a._origLatLng,b);a._middleLeft&&a._middleLeft.setLatLng(this._getMiddleLatLng(a._prev,a));a._middleRight&&a._middleRight.setLatLng(this._getMiddleLatLng(a,a._next));this._poly.redraw();this.updateMarkers()},_updateIndexes:function(a,b){this._markerGroup.eachLayer(function(d){d._index>a&&(d._index+=b)})},_createMiddleMarker:function(a,b){var d=this._getMiddleLatLng(a,b),c=this._createMarker(d);c.setOpacity(.6);a._middleRight=b._middleLeft=c;var e=function(){c.off("touchmove",e,
this);var f=b._index;c._index=f;c.off("click",g,this).on("click",this._onMarkerClick,this);d.lat=c.getLatLng().lat;d.lng=c.getLatLng().lng;this._spliceLatLngs(f,0,d);this._markers.splice(f,0,c);c.setOpacity(1);this._updateIndexes(f,1);b._index++;this._updatePrevNext(a,c);this._updatePrevNext(c,b);this._poly.fire("editstart")};var f=function(){c.off("dragstart",e,this);c.off("dragend",f,this);c.off("touchmove",e,this);this._createMiddleMarker(a,c);this._createMiddleMarker(c,b)};var g=function(){e.call(this);
f.call(this);this._fireEdit()};c.on("click",g,this).on("dragstart",e,this).on("dragend",f,this).on("touchmove",e,this);this._markerGroup.addLayer(c)},_updatePrevNext:function(a,b){a&&(a._next=b);b&&(b._prev=a)},_getMiddleLatLng:function(a,b){var d=this._poly._map;a=d.project(a.getLatLng());b=d.project(b.getLatLng());return d.unproject(a._add(b)._divideBy(2))}});