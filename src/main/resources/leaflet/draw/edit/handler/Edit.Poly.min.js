L.Edit=L.Edit||{};
L.Edit.Poly=L.Handler.extend({initialize:function(a){this.latlngs=[a._latlngs];a._holes&&(this.latlngs=this.latlngs.concat(a._holes));this._poly=a;this._poly.on("revert-edited",this._updateLatLngs,this)},_defaultShape:function(){return L.Polyline._flat?L.Polyline._flat(this._poly._latlngs)?this._poly._latlngs:this._poly._latlngs[0]:this._poly._latlngs},_eachVertexHandler:function(a){for(var b=0;b<this._verticesHandlers.length;b++)a(this._verticesHandlers[b])},addHooks:function(){this._initHandlers();this._eachVertexHandler(function(a){a.addHooks()})},
removeHooks:function(){this._eachVertexHandler(function(a){a.removeHooks()})},updateMarkers:function(){this._eachVertexHandler(function(a){a.updateMarkers()})},_initHandlers:function(){this._verticesHandlers=[];for(var a=0;a<this.latlngs.length;a++)this._verticesHandlers.push(new L.Edit.PolyVerticesEdit(this._poly,this.latlngs[a],this._poly.options.poly))},_updateLatLngs:function(a){this.latlngs=[a.layer._latlngs];a.layer._holes&&(this.latlngs=this.latlngs.concat(a.layer._holes))}});
L.Edit.PolyVerticesEdit=L.Handler.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),drawError:{color:"#b00b00",timeout:1E3}},initialize:function(a,b,c){L.Browser.touch&&(this.options.icon=this.options.touchIcon);this._poly=a;c&&c.drawError&&(c.drawError=L.Util.extend({},this.options.drawError,c.drawError));this._latlngs=
b;L.setOptions(this,c)},_defaultShape:function(){return L.Polyline._flat?L.Polyline._flat(this._latlngs)?this._latlngs:this._latlngs[0]:this._latlngs},addHooks:function(){var a=this._poly,b=a._path;a instanceof L.Polygon||(a.options.fill=!1,a.options.editing&&(a.options.editing.fill=!1));b&&a.options.editing&&a.options.editing.className&&(a.options.original.className&&a.options.original.className.split(" ").forEach(function(a){L.DomUtil.removeClass(b,a)}),a.options.editing.className.split(" ").forEach(function(a){L.DomUtil.addClass(b,
a)}));a.setStyle(a.options.editing);this._poly._map&&(this._map=this._poly._map,this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup))},removeHooks:function(){var a=this._poly,b=a._path;b&&a.options.editing&&a.options.editing.className&&(a.options.editing.className.split(" ").forEach(function(a){L.DomUtil.removeClass(b,a)}),a.options.original.className&&a.options.original.className.split(" ").forEach(function(a){L.DomUtil.addClass(b,a)}));a.setStyle(a.options.original);
a._map&&(a._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers)},updateMarkers:function(){this._markerGroup.clearLayers();this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup);this._markers=[];var a=this._defaultShape(),b;var c=0;for(b=a.length;c<b;c++){var d=this._createMarker(a[c],c);d.on("click",this._onMarkerClick,this);d.on("contextmenu",this._onContextMenu,this);this._markers.push(d)}c=0;for(a=b-1;c<b;a=c++)if(0!==
c||L.Polygon&&this._poly instanceof L.Polygon)a=this._markers[a],d=this._markers[c],this._createMiddleMarker(a,d),this._updatePrevNext(a,d)},_createMarker:function(a,b){var c=new L.Marker.Touch(a,{draggable:!0,icon:this.options.icon});c._origLatLng=a;c._index=b;c.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._fireEdit,this).on("touchmove",this._onTouchMove,this).on("touchend",this._fireEdit,this).on("MSPointerMove",this._onTouchMove,this).on("MSPointerUp",
this._fireEdit,this);this._markerGroup.addLayer(c);return c},_onMarkerDragStart:function(){this._poly.fire("editstart")},_spliceLatLngs:function(){var a=this._defaultShape(),b=[].splice.apply(a,arguments);this._poly._convertLatLngs(a,!0);this._poly.redraw();return b},_removeMarker:function(a){var b=a._index;this._markerGroup.removeLayer(a);this._markers.splice(b,1);this._spliceLatLngs(b,1);this._updateIndexes(b,-1);a.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",
this._fireEdit,this).off("touchmove",this._onMarkerDrag,this).off("touchend",this._fireEdit,this).off("click",this._onMarkerClick,this).off("MSPointerMove",this._onTouchMove,this).off("MSPointerUp",this._fireEdit,this)},_fireEdit:function(){this._poly.edited=!0;this._poly.fire("edit");this._poly._map.fire(L.Draw.Event.EDITVERTEX,{layers:this._markerGroup,poly:this._poly})},_onMarkerDrag:function(a){var b=a.target,c=this._poly;L.extend(b._origLatLng,b._latlng);b._middleLeft&&b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,
b));b._middleRight&&b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next));if(c.options.poly){var d=c._map._editTooltip;if(!c.options.poly.allowIntersection&&c.intersects()){var e=c.options.color;c.setStyle({color:this.options.drawError.color});0!==L.version.indexOf("0.7")&&b.dragging._draggable._onUp(a);this._onMarkerClick(a);d&&d.updateContent({text:L.drawLocal.draw.handlers.polyline.error});setTimeout(function(){c.setStyle({color:e});d&&d.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.text,
subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext})},1E3)}}this._poly._bounds._southWest=L.latLng(Infinity,Infinity);this._poly._bounds._northEast=L.latLng(-Infinity,-Infinity);a=this._poly.getLatLngs();this._poly._convertLatLngs(a,!0);this._poly.redraw();this._poly.fire("editdrag")},_onMarkerClick:function(a){var b=L.Polygon&&this._poly instanceof L.Polygon?4:3;a=a.target;this._defaultShape().length<b||(this._removeMarker(a),this._updatePrevNext(a._prev,a._next),a._middleLeft&&this._markerGroup.removeLayer(a._middleLeft),
a._middleRight&&this._markerGroup.removeLayer(a._middleRight),a._prev&&a._next?this._createMiddleMarker(a._prev,a._next):a._prev?a._next||(a._prev._middleRight=null):a._next._middleLeft=null,this._fireEdit())},_onContextMenu:function(a){this._poly._map.fire(L.Draw.Event.MARKERCONTEXT,{marker:a.target,layers:this._markerGroup,poly:this._poly});L.DomEvent.stopPropagation},_onTouchMove:function(a){var b=this._map.mouseEventToLayerPoint(a.originalEvent.touches[0]);b=this._map.layerPointToLatLng(b);a=
a.target;L.extend(a._origLatLng,b);a._middleLeft&&a._middleLeft.setLatLng(this._getMiddleLatLng(a._prev,a));a._middleRight&&a._middleRight.setLatLng(this._getMiddleLatLng(a,a._next));this._poly.redraw();this.updateMarkers()},_updateIndexes:function(a,b){this._markerGroup.eachLayer(function(c){c._index>a&&(c._index+=b)})},_createMiddleMarker:function(a,b){var c=this._getMiddleLatLng(a,b),d=this._createMarker(c);d.setOpacity(.6);a._middleRight=b._middleLeft=d;var e=function(){d.off("touchmove",e,this);
var f=b._index;d._index=f;d.off("click",h,this).on("click",this._onMarkerClick,this);c.lat=d.getLatLng().lat;c.lng=d.getLatLng().lng;this._spliceLatLngs(f,0,c);this._markers.splice(f,0,d);d.setOpacity(1);this._updateIndexes(f,1);b._index++;this._updatePrevNext(a,d);this._updatePrevNext(d,b);this._poly.fire("editstart")};var g=function(){d.off("dragstart",e,this);d.off("dragend",g,this);d.off("touchmove",e,this);this._createMiddleMarker(a,d);this._createMiddleMarker(d,b)};var h=function(){e.call(this);
g.call(this);this._fireEdit()};d.on("click",h,this).on("dragstart",e,this).on("dragend",g,this).on("touchmove",e,this);this._markerGroup.addLayer(d)},_updatePrevNext:function(a,b){a&&(a._next=b);b&&(b._prev=a)},_getMiddleLatLng:function(a,b){var c=this._poly._map;a=c.project(a.getLatLng());b=c.project(b.getLatLng());return c.unproject(a._add(b)._divideBy(2))}});
L.Polyline.addInitHook(function(){this.editing||(L.Edit.Poly&&(this.editing=new L.Edit.Poly(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()}))});