(function(c){if("function"===typeof define&&define.amd)define(["leaflet"],c);else if("undefined"!==typeof module)module.exports=c(require("leaflet"));else{if("undefined"===typeof window.L)throw"Leaflet must be loaded first";c(window.L)}})(function(c){c.Control.Search=c.Control.extend({includes:"1"===c.version[0]?c.Evented.prototype:c.Mixin.Events,options:{url:"",layer:null,sourceData:null,jsonpParam:null,propertyLoc:"loc",propertyName:"title",formatData:null,filterData:null,moveToLocation:null,buildTip:null,
container:"",zoom:null,minLength:1,initial:!0,casesensitive:!1,autoType:!0,delayType:400,tooltipLimit:-1,tipAutoSubmit:!0,firstTipSubmit:!1,autoResize:!0,collapsed:!0,autoCollapse:!1,autoCollapseTime:1200,textErr:"Location not found",textCancel:"Cancel",textPlaceholder:"Search...",hideMarkerOnCollapse:!1,position:"topleft",marker:{icon:!1,animate:!0,circle:{radius:10,weight:3,color:"#e03",stroke:!0,fill:!1}}},_getPath:function(a,b){b=b.split(".");var c=b.pop(),e=b.length,f=b[0],g=1;if(0<e)for(;(a=
a[f])&&g<e;)f=b[g++];if(a)return a[c]},_isObject:function(a){return"[object Object]"===Object.prototype.toString.call(a)},initialize:function(a){c.Util.setOptions(this,a||{});this._inputMinSize=this.options.textPlaceholder?this.options.textPlaceholder.length:10;this._layer=this.options.layer||new c.LayerGroup;this._filterData=this.options.filterData||this._defaultFilterData;this._formatData=this.options.formatData||this._defaultFormatData;this._moveToLocation=this.options.moveToLocation||this._defaultMoveToLocation;
this._autoTypeTmp=this.options.autoType;this._countertips=0;this._recordsCache={};this._curReq=null},onAdd:function(a){this._map=a;this._container=c.DomUtil.create("div","leaflet-control-search");this._input=this._createInput(this.options.textPlaceholder,"search-input");this._tooltip=this._createTooltip("search-tooltip");this._cancel=this._createCancel(this.options.textCancel,"search-cancel");this._button=this._createButton(this.options.textPlaceholder,"search-button");this._alert=this._createAlert("search-alert");
!1===this.options.collapsed&&this.expand(this.options.collapsed);this.options.marker&&(this.options.marker instanceof c.Marker||this.options.marker instanceof c.CircleMarker?this._markerSearch=this.options.marker:this._isObject(this.options.marker)&&(this._markerSearch=new c.Control.Search.Marker([0,0],this.options.marker)),this._markerSearch._isMarkerSearch=!0);this.setLayer(this._layer);a.on({resize:this._handleAutoresize},this);return this._container},addTo:function(a){this.options.container?(this._container=
this.onAdd(a),this._wrapper=c.DomUtil.get(this.options.container),this._wrapper.style.position="relative",this._wrapper.appendChild(this._container)):c.Control.prototype.addTo.call(this,a);return this},onRemove:function(a){this._recordsCache={}},setLayer:function(a){this._layer=a;this._layer.addTo(this._map);return this},showAlert:function(a){var b=this;a=a||this.options.textErr;this._alert.style.display="block";this._alert.innerHTML=a;clearTimeout(this.timerAlert);this.timerAlert=setTimeout(function(){b.hideAlert()},
this.options.autoCollapseTime);return this},hideAlert:function(){this._alert.style.display="none";return this},cancel:function(){this._input.value="";this._handleKeypress({keyCode:8});this._input.size=this._inputMinSize;this._input.focus();this._cancel.style.display="none";this._hideTooltip();this.fire("search:cancel");return this},expand:function(a){a="boolean"===typeof a?a:!0;this._input.style.display="block";c.DomUtil.addClass(this._container,"search-exp");!1!==a&&(this._input.focus(),this._map.on("dragstart click",
this.collapse,this));this.fire("search:expanded");return this},collapse:function(){this._hideTooltip();this.cancel();this._alert.style.display="none";this._input.blur();this.options.collapsed&&(this._input.style.display="none",this._cancel.style.display="none",c.DomUtil.removeClass(this._container,"search-exp"),this.options.hideMarkerOnCollapse&&this._map.removeLayer(this._markerSearch),this._map.off("dragstart click",this.collapse,this));this.fire("search:collapsed");return this},collapseDelayed:function(){var a=
this;if(!this.options.autoCollapse)return this;clearTimeout(this.timerCollapse);this.timerCollapse=setTimeout(function(){a.collapse()},this.options.autoCollapseTime);return this},collapseDelayedStop:function(){clearTimeout(this.timerCollapse);return this},_createAlert:function(a){a=c.DomUtil.create("div",a,this._container);a.style.display="none";c.DomEvent.on(a,"click",c.DomEvent.stop,this).on(a,"click",this.hideAlert,this);return a},_createInput:function(a,b){var d=c.DomUtil.create("label",b,this._container);
b=c.DomUtil.create("input",b,this._container);b.type="text";b.size=this._inputMinSize;b.value="";b.autocomplete="off";b.autocorrect="off";b.autocapitalize="off";b.placeholder=a;b.style.display="none";b.role="search";b.id=b.role+b.type+b.size;d.htmlFor=b.id;d.style.display="none";d.value=a;c.DomEvent.disableClickPropagation(b).on(b,"keyup",this._handleKeypress,this).on(b,"blur",this.collapseDelayed,this).on(b,"focus",this.collapseDelayedStop,this);return b},_createCancel:function(a,b){b=c.DomUtil.create("a",
b,this._container);b.href="#";b.title=a;b.style.display="none";b.innerHTML="<span>&otimes;</span>";c.DomEvent.on(b,"click",c.DomEvent.stop,this).on(b,"click",this.cancel,this);return b},_createButton:function(a,b){b=c.DomUtil.create("a",b,this._container);b.href="#";b.title=a;c.DomEvent.on(b,"click",c.DomEvent.stop,this).on(b,"click",this._handleSubmit,this).on(b,"focus",this.collapseDelayedStop,this).on(b,"blur",this.collapseDelayed,this);return b},_createTooltip:function(a){var b=this;a=c.DomUtil.create("ul",
a,this._container);a.style.display="none";c.DomEvent.disableClickPropagation(a).on(a,"blur",this.collapseDelayed,this).on(a,"mousewheel",function(a){b.collapseDelayedStop();c.DomEvent.stopPropagation(a)},this).on(a,"mouseover",function(a){b.collapseDelayedStop()},this);return a},_createTip:function(a,b){if(this.options.buildTip){if(b=this.options.buildTip.call(this,a,b),"string"===typeof b){var d=c.DomUtil.create("div");d.innerHTML=b;b=d.firstChild}}else b=c.DomUtil.create("li",""),b.innerHTML=a;
c.DomUtil.addClass(b,"search-tip");b._text=a;if(this.options.tipAutoSubmit)c.DomEvent.disableClickPropagation(b).on(b,"click",c.DomEvent.stop,this).on(b,"click",function(b){this._input.value=a;this._handleAutoresize();this._input.focus();this._hideTooltip();this._handleSubmit()},this);return b},_getUrl:function(a){return"function"===typeof this.options.url?this.options.url(a):this.options.url},_defaultFilterData:function(a,b){var c={};a=a.replace(/[.*+?^${}()|[\]\\]/g,"");if(""===a)return[];a=new RegExp((this.options.initial?
"^":"")+a,this.options.casesensitive?void 0:"i");for(var e in b)a.test(e)&&(c[e]=b[e]);return c},showTooltip:function(a){this._countertips=0;this._tooltip.innerHTML="";this._tooltip.currentSelection=-1;if(this.options.tooltipLimit)for(var b in a){if(this._countertips===this.options.tooltipLimit)break;this._countertips++;this._tooltip.appendChild(this._createTip(b,a[b]))}0<this._countertips?(this._tooltip.style.display="block",this._autoTypeTmp&&this._autoType(),this._autoTypeTmp=this.options.autoType):
this._hideTooltip();this._tooltip.scrollTop=0;return this._countertips},_hideTooltip:function(){this._tooltip.style.display="none";this._tooltip.innerHTML="";return 0},_defaultFormatData:function(a){var b=this.options.propertyName,d=this.options.propertyLoc,e,f={};if(c.Util.isArray(d))for(e in a)f[this._getPath(a[e],b)]=c.latLng(a[e][d[0]],a[e][d[1]]);else for(e in a)f[this._getPath(a[e],b)]=c.latLng(this._getPath(a[e],d));return f},_recordsFromJsonp:function(a,b){c.Control.Search.callJsonp=b;var d=
c.DomUtil.create("script","leaflet-search-jsonp",document.getElementsByTagName("body")[0]);a=c.Util.template(this._getUrl(a)+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:a});d.type="text/javascript";d.src=a;return{abort:function(){d.parentNode.removeChild(d)}}},_recordsFromAjax:function(a,b){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(f){throw Error("XMLHttpRequest is not supported");
}}});var d=c.Browser.ie&&!window.atob&&document.querySelector?new XDomainRequest:new XMLHttpRequest;a=c.Util.template(this._getUrl(a),{s:a});d.open("GET",a);d.onload=function(){b(JSON.parse(d.responseText))};d.onreadystatechange=function(){if(4===d.readyState&&200===d.status)this.onload()};d.send();return d},_searchInLayer:function(a,b,d){var e=this;if(!(a instanceof c.Control.Search.Marker))if(a instanceof c.Marker||a instanceof c.CircleMarker)if(e._getPath(a.options,d)){var f=a.getLatLng();f.layer=
a;b[e._getPath(a.options,d)]=f}else e._getPath(a.feature.properties,d)?(f=a.getLatLng(),f.layer=a,b[e._getPath(a.feature.properties,d)]=f):console.warn("propertyName '"+d+"' not found in marker");else a instanceof c.Path||a instanceof c.Polyline||a instanceof c.Polygon?e._getPath(a.options,d)?(f=a.getBounds().getCenter(),f.layer=a,b[e._getPath(a.options,d)]=f):e._getPath(a.feature.properties,d)?(f=a.getBounds().getCenter(),f.layer=a,b[e._getPath(a.feature.properties,d)]=f):console.warn("propertyName '"+
d+"' not found in shape"):a.hasOwnProperty("feature")?a.feature.properties.hasOwnProperty(d)?a.getLatLng&&"function"===typeof a.getLatLng?(f=a.getLatLng(),f.layer=a,b[a.feature.properties[d]]=f):a.getBounds&&"function"===typeof a.getBounds?(f=a.getBounds().getCenter(),f.layer=a,b[a.feature.properties[d]]=f):console.warn("Unknown type of Layer"):console.warn("propertyName '"+d+"' not found in feature"):a instanceof c.LayerGroup&&a.eachLayer(function(a){e._searchInLayer(a,b,d)})},_recordsFromLayer:function(){var a=
this,b={},c=this.options.propertyName;this._layer.eachLayer(function(d){a._searchInLayer(d,b,c)});return b},_autoType:function(){var a=this._input.value.length,b=this._tooltip.firstChild?this._tooltip.firstChild._text:"",c=b.length;0===b.indexOf(this._input.value)&&(this._input.value=b,this._handleAutoresize(),this._input.createTextRange?(b=this._input.createTextRange(),b.collapse(!0),b.moveStart("character",a),b.moveEnd("character",c),b.select()):this._input.setSelectionRange?this._input.setSelectionRange(a,
c):this._input.selectionStart&&(this._input.selectionStart=a,this._input.selectionEnd=c))},_hideAutoType:function(){var a;if((a=this._input.selection)&&a.empty)a.empty();else if(this._input.createTextRange){a=this._input.createTextRange();a.collapse(!0);var b=this._input.value.length;a.moveStart("character",b);a.moveEnd("character",b);a.select()}else this._input.getSelection&&this._input.getSelection().removeAllRanges(),this._input.selectionStart=this._input.selectionEnd},_handleKeypress:function(a){var b=
this;switch(a.keyCode){case 27:this.collapse();break;case 13:(1==this._countertips||this.options.firstTipSubmit&&0<this._countertips)&&-1==this._tooltip.currentSelection&&this._handleArrowSelect(1);this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 8:case 45:case 46:this._autoTypeTmp=!1;break;case 37:case 39:case 16:case 17:case 35:case 36:break;default:this._cancel.style.display=this._input.value.length?"block":"none",this._input.value.length>=
this.options.minLength?(clearTimeout(this.timerKeypress),this.timerKeypress=setTimeout(function(){b._fillRecordsCache()},this.options.delayType)):this._hideTooltip()}this._handleAutoresize()},searchText:function(a){var b=a.charCodeAt(a.length);this._input.value=a;this._input.style.display="block";c.DomUtil.addClass(this._container,"search-exp");this._autoTypeTmp=!1;this._handleKeypress({keyCode:b})},_fillRecordsCache:function(){var a=this,b=this._input.value;this._curReq&&this._curReq.abort&&this._curReq.abort();
c.DomUtil.addClass(this._container,"search-load");if(this.options.layer){this._recordsCache=this._recordsFromLayer();var d=this._filterData(this._input.value,this._recordsCache);this.showTooltip(d);c.DomUtil.removeClass(this._container,"search-load")}else this.options.sourceData?this._retrieveData=this.options.sourceData:this.options.url&&(this._retrieveData=this.options.jsonpParam?this._recordsFromJsonp:this._recordsFromAjax),this._curReq=this._retrieveData.call(this,b,function(b){a._recordsCache=
a._formatData.call(a,b);d=a.options.sourceData?a._filterData(a._input.value,a._recordsCache):a._recordsCache;a.showTooltip(d);c.DomUtil.removeClass(a._container,"search-load")})},_handleAutoresize:function(){if(this._input.style.maxWidth!==this._map._container.offsetWidth){var a=this._map._container.clientWidth;this._input.style.maxWidth=(a-83).toString()+"px"}this.options.autoResize&&this._container.offsetWidth+20<this._map._container.offsetWidth&&(this._input.size=this._input.value.length<this._inputMinSize?
this._inputMinSize:this._input.value.length)},_handleArrowSelect:function(a){var b=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<b.length;i++)c.DomUtil.removeClass(b[i],"search-tip-select");1==a&&this._tooltip.currentSelection>=b.length-1?c.DomUtil.addClass(b[this._tooltip.currentSelection],"search-tip-select"):-1==a&&0>=this._tooltip.currentSelection?this._tooltip.currentSelection=-1:"none"!=this._tooltip.style.display&&(this._tooltip.currentSelection+=a,c.DomUtil.addClass(b[this._tooltip.currentSelection],
"search-tip-select"),this._input.value=b[this._tooltip.currentSelection]._text,a=b[this._tooltip.currentSelection].offsetTop,a+b[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight?this._tooltip.scrollTop=a-this._tooltip.clientHeight+b[this._tooltip.currentSelection].clientHeight:a<=this._tooltip.scrollTop&&(this._tooltip.scrollTop=a))},_handleSubmit:function(){this._hideAutoType();this.hideAlert();this._hideTooltip();if("none"==this._input.style.display)this.expand();
else if(""===this._input.value)this.collapse();else{var a=this._getLocation(this._input.value);if(!1===a)this.showAlert();else{var b=this._input.value;this.showLocation(a,this._input.value);this.fire("search:locationfound",{latlng:a,text:b,layer:a.layer?a.layer:null})}}},_getLocation:function(a){return this._recordsCache.hasOwnProperty(a)?this._recordsCache[a]:!1},_defaultMoveToLocation:function(a,b,c){this.options.zoom?this._map.setView(a,this.options.zoom):this._map.panTo(a)},showLocation:function(a,
b){var c=this;c._map.once("moveend zoomend",function(b){c._markerSearch&&c._markerSearch.addTo(c._map).setLatLng(a)});c._moveToLocation(a,b,c._map);c.options.autoCollapse&&c.collapse();return c}});c.Control.Search.Marker=c.Marker.extend({includes:"1"===c.version[0]?c.Evented.prototype:c.Mixin.Events,options:{icon:new c.Icon.Default,animate:!0,circle:{radius:10,weight:3,color:"#e03",stroke:!0,fill:!1}},initialize:function(a,b){c.setOptions(this,b);!0===b.icon&&(b.icon=new c.Icon.Default);c.Marker.prototype.initialize.call(this,
a,b);c.Control.Search.prototype._isObject(this.options.circle)&&(this._circleLoc=new c.CircleMarker(a,this.options.circle))},onAdd:function(a){c.Marker.prototype.onAdd.call(this,a);this._circleLoc&&(a.addLayer(this._circleLoc),this.options.animate&&this.animate())},onRemove:function(a){c.Marker.prototype.onRemove.call(this,a);this._circleLoc&&a.removeLayer(this._circleLoc)},setLatLng:function(a){c.Marker.prototype.setLatLng.call(this,a);this._circleLoc&&this._circleLoc.setLatLng(a);return this},_initIcon:function(){this.options.icon&&
c.Marker.prototype._initIcon.call(this)},_removeIcon:function(){this.options.icon&&c.Marker.prototype._removeIcon.call(this)},animate:function(){if(this._circleLoc){var a=this._circleLoc,b=parseInt(a._radius/5),c=this.options.circle.radius,e=2*a._radius,f=0;a._timerAnimLoc=setInterval(function(){f+=.5;b+=f;e-=b;a.setRadius(e);e<c&&(clearInterval(a._timerAnimLoc),a.setRadius(c))},200)}return this}});c.Map.addInitHook(function(){this.options.searchControl&&(this.searchControl=c.control.search(this.options.searchControl),
this.addControl(this.searchControl))});c.control.search=function(a){return new c.Control.Search(a)};return c.Control.Search});