L.HeatLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(a,b){this._latlngs=a;L.setOptions(this,b)},setLatLngs:function(a){this._latlngs=a;return this.redraw()},addLatLng:function(a){this._latlngs.push(a);return this.redraw()},clearLatLngs:function(){this._latlngs=[];return this.redraw()},setOptions:function(a){L.setOptions(this,a);this._heat&&this._updateOptions();return this.redraw()},redraw:function(){this._heat&&!this._frame&&this._map&&!this._map._animating&&(this._frame=L.Util.requestAnimFrame(this._redraw,
this));return this},onAdd:function(a){this._map=a;this._canvas||this._initCanvas();this.options.pane?this.getPane().appendChild(this._canvas):a._panes.overlayPane.appendChild(this._canvas);a.on("moveend",this._reset,this);if(a.options.zoomAnimation&&L.Browser.any3d)a.on("zoomanim",this._animateZoom,this);this._reset()},onRemove:function(a){this.options.pane?this.getPane().removeChild(this._canvas):a.getPanes().overlayPane.removeChild(this._canvas);a.off("moveend",this._reset,this);a.options.zoomAnimation&&
a.off("zoomanim",this._animateZoom,this)},addTo:function(a){a.addLayer(this);return this},_initCanvas:function(){var a=this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer leaflet-layer"),b=L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","msTransformOrigin"]);a.style[b]="50% 50%";b=this._map.getSize();a.width=b.x;a.height=b.y;L.DomUtil.addClass(a,"leaflet-zoom-"+(this._map.options.zoomAnimation&&L.Browser.any3d?"animated":"hide"));this._heat=simpleheat(a);this._updateOptions()},
_updateOptions:function(){this._heat.radius(this.options.radius||this._heat.defaultRadius,this.options.blur);this.options.gradient&&this._heat.gradient(this.options.gradient);this.options.max&&this._heat.max(this.options.max)},_reset:function(){var a=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,a);a=this._map.getSize();this._heat._width!==a.x&&(this._canvas.width=this._heat._width=a.x);this._heat._height!==a.y&&(this._canvas.height=this._heat._height=a.y);this._redraw()},
_redraw:function(){if(this._map){var a=[],b=this._heat._r,n=this._map.getSize(),g=new L.Bounds(L.point([-b,-b]),n.add([b,b]));n=void 0===this.options.min?0:this.options.min;var q=void 0===this.options.max?1:this.options.max,h=void 0===this.options.maxZoom?this._map.getMaxZoom():this.options.maxZoom;h=1/Math.pow(2,Math.max(0,Math.min(h-this._map.getZoom(),12)));var k=b/2;b=[];var c=this._map._getMapPanePos(),r=c.x%k,t=c.y%k,l,d;c=0;for(l=this._latlngs.length;c<l;c++){var e=this._map.latLngToContainerPoint(this._latlngs[c]);
if(g.contains(e)){var p=Math.floor((e.x-r)/k)+2;var m=Math.floor((e.y-t)/k)+2;var f=(void 0!==this._latlngs[c].alt?this._latlngs[c].alt:void 0!==this._latlngs[c][2]?+this._latlngs[c][2]:1)*h;b[m]=b[m]||[];(d=b[m][p])?(d[0]=(d[0]*d[2]+e.x*f)/(d[2]+f),d[1]=(d[1]*d[2]+e.y*f)/(d[2]+f),d[2]+=f):b[m][p]=[e.x,e.y,f]}}c=0;for(l=b.length;c<l;c++)if(b[c])for(g=0,h=b[c].length;g<h;g++)(d=b[c][g])&&d[2]>n&&a.push([Math.round(d[0]),Math.round(d[1]),Math.min(d[2],q)]);this._heat.data(a).draw(this.options.minOpacity);
this._frame=null}},_animateZoom:function(a){var b=this._map.getZoomScale(a.zoom);a=this._map._getCenterOffset(a.center)._multiplyBy(-b).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,a,b):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(a)+" scale("+b+")"}});L.heatLayer=function(a,b){return new L.HeatLayer(a,b)};