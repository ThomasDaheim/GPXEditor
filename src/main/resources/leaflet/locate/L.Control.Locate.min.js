/*
 Copyright (c) 2016 Dominik Moritz

This file is part of the leaflet locate control. It is licensed under the MIT license.
You can find the project at: https://github.com/domoritz/leaflet-locatecontrol
*/
(function(c,g){"function"===typeof define&&define.amd?define(["leaflet"],c):"object"===typeof exports&&(module.exports="undefined"!==typeof g&&g.L?c(L):c(require("leaflet")));"undefined"!==typeof g&&g.L&&(g.L.Control.Locate=c(L))})(function(c){var g=function(a,b,d){d=d.split(" ");d.forEach(function(d){c.DomUtil[a].call(this,b,d)})},h=function(a,b){g("addClass",a,b)},e=function(a,b){g("removeClass",a,b)},k=c.Marker.extend({initialize:function(a,b){c.Util.setOptions(this,b);this._latlng=a;this.createIcon()},
createIcon:function(){var a=this.options,b="";void 0!==a.color&&(b+="stroke:"+a.color+";");void 0!==a.weight&&(b+="stroke-width:"+a.weight+";");void 0!==a.fillColor&&(b+="fill:"+a.fillColor+";");void 0!==a.fillOpacity&&(b+="fill-opacity:"+a.fillOpacity+";");void 0!==a.opacity&&(b+="opacity:"+a.opacity+";");a=this._getIconSVG(a,b);this._locationIcon=c.divIcon({className:a.className,html:a.svg,iconSize:[a.w,a.h]});this.setIcon(this._locationIcon)},_getIconSVG:function(a,b){var c=a.radius;a=c+a.weight;
var f=2*a;return{className:"leaflet-control-locate-location",svg:'<svg xmlns="http://www.w3.org/2000/svg" width="'+f+'" height="'+f+'" version="1.1" viewBox="-'+a+" -"+a+" "+f+" "+f+'"><circle r="'+c+'" style="'+b+'" /></svg>',w:f,h:f}},setStyle:function(a){c.Util.setOptions(this,a);this.createIcon()}}),l=k.extend({initialize:function(a,b,d){c.Util.setOptions(this,d);this._latlng=a;this._heading=b;this.createIcon()},setHeading:function(a){this._heading=a},_getIconSVG:function(a,b){var c=a.width+a.weight,
f=2*(a.radius+a.depth+a.weight);return{className:"leaflet-control-locate-heading",svg:'<svg xmlns="http://www.w3.org/2000/svg" width="'+c+'" height="'+f+'" version="1.1" viewBox="-'+c/2+" 0 "+c+" "+f+'" style="'+("transform: rotate("+this._heading+"deg)")+'"><path d="'+("M0,0 l"+a.width/2+","+a.depth+" l-"+c+",0 z")+'" style="'+b+'" /></svg>',w:c,h:f}}});k=c.Control.extend({options:{position:"topleft",layer:void 0,setView:"untilPanOrZoom",keepCurrentZoomLevel:!1,initialZoomLevel:!1,getLocationBounds:function(a){return a.bounds},
flyTo:!1,clickBehavior:{inView:"stop",outOfView:"setView",inViewNotFollowing:"inView"},returnToPrevBounds:!1,cacheLocation:!0,drawCircle:!0,drawMarker:!0,showCompass:!0,markerClass:k,compassClass:l,circleStyle:{className:"leaflet-control-locate-circle",color:"#136AEC",fillColor:"#136AEC",fillOpacity:.15,weight:0},markerStyle:{className:"leaflet-control-locate-marker",color:"#fff",fillColor:"#2A93EE",fillOpacity:1,weight:3,opacity:1,radius:9},compassStyle:{fillColor:"#2A93EE",fillOpacity:1,weight:0,
color:"#fff",opacity:1,radius:9,width:9,depth:6},followCircleStyle:{},followMarkerStyle:{},followCompassStyle:{},icon:"fa fa-map-marker",iconLoading:"fa fa-spinner fa-spin",iconElementTag:"span",circlePadding:[0,0],metric:!0,createButtonCallback:function(a,b){a=c.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",a);a.title=b.strings.title;a.role="button";a.href="#";b=c.DomUtil.create(b.iconElementTag,b.icon,a);return{link:a,icon:b}},onLocationError:function(a,b){alert(a.message)},onLocationOutsideMapBounds:function(a){a.stop();
alert(a.options.strings.outsideMapBoundsMsg)},showPopup:!0,strings:{title:"Show me where I am",metersUnit:"meters",feetUnit:"feet",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:Infinity,watch:!0,setView:!1}},initialize:function(a){for(var b in a)"object"===typeof this.options[b]?c.extend(this.options[b],a[b]):this.options[b]=a[b];this.options.followMarkerStyle=c.extend({},this.options.markerStyle,
this.options.followMarkerStyle);this.options.followCircleStyle=c.extend({},this.options.circleStyle,this.options.followCircleStyle);this.options.followCompassStyle=c.extend({},this.options.compassStyle,this.options.followCompassStyle)},onAdd:function(a){var b=c.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control");this._container=b;this._map=a;this._layer=this.options.layer||new c.LayerGroup;this._layer.addTo(a);this._event=void 0;this._prevBounds=this._compassHeading=null;a=
this.options.createButtonCallback(b,this.options);this._link=a.link;this._icon=a.icon;c.DomEvent.on(this._link,"click",c.DomEvent.stopPropagation).on(this._link,"click",c.DomEvent.preventDefault).on(this._link,"click",this._onClick,this).on(this._link,"dblclick",c.DomEvent.stopPropagation);this._resetVariables();this._map.on("unload",this._unload,this);return b},_onClick:function(){this._justClicked=!0;var a=this._isFollowing();this._userZoomed=this._userPanned=!1;if(this._active&&!this._event)this.stop();
else if(this._active&&void 0!==this._event){var b=this.options.clickBehavior,c=b.outOfView;this._map.getBounds().contains(this._event.latlng)&&(c=a?b.inView:b.inViewNotFollowing);b[c]&&(c=b[c]);switch(c){case "setView":this.setView();break;case "stop":this.stop(),this.options.returnToPrevBounds&&(this.options.flyTo?this._map.flyToBounds:this._map.fitBounds).bind(this._map)(this._prevBounds)}}else this.options.returnToPrevBounds&&(this._prevBounds=this._map.getBounds()),this.start();this._updateContainerStyle()},
start:function(){this._activate();this._event&&(this._drawMarker(this._map),this.options.setView&&this.setView());this._updateContainerStyle()},stop:function(){this._deactivate();this._cleanClasses();this._resetVariables();this._removeMarker()},stopFollowing:function(){this._userPanned=!0;this._updateContainerStyle();this._drawMarker()},_activate:function(){if(!this._active&&(this._map.locate(this.options.locateOptions),this._active=!0,this._map.on("locationfound",this._onLocationFound,this),this._map.on("locationerror",
this._onLocationError,this),this._map.on("dragstart",this._onDrag,this),this._map.on("zoomstart",this._onZoom,this),this._map.on("zoomend",this._onZoomEnd,this),this.options.showCompass)){var a="ondeviceorientationabsolute"in window;if(a||"ondeviceorientation"in window){var b=this,d=function(){c.DomEvent.on(window,a?"deviceorientationabsolute":"deviceorientation",b._onDeviceOrientation,b)};DeviceOrientationEvent&&"function"===typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(function(a){"granted"===
a&&d()}):d()}}},_deactivate:function(){this._map.stopLocate();this._active=!1;this.options.cacheLocation||(this._event=void 0);this._map.off("locationfound",this._onLocationFound,this);this._map.off("locationerror",this._onLocationError,this);this._map.off("dragstart",this._onDrag,this);this._map.off("zoomstart",this._onZoom,this);this._map.off("zoomend",this._onZoomEnd,this);this.options.showCompass&&(this._compassHeading=null,"ondeviceorientationabsolute"in window?c.DomEvent.off(window,"deviceorientationabsolute",
this._onDeviceOrientation,this):"ondeviceorientation"in window&&c.DomEvent.off(window,"deviceorientation",this._onDeviceOrientation,this))},setView:function(){this._drawMarker();if(this._isOutsideMapBounds())this._event=void 0,this.options.onLocationOutsideMapBounds(this);else if(this._justClicked&&!1!==this.options.initialZoomLevel){var a=this.options.flyTo?this._map.flyTo:this._map.setView;a.bind(this._map)([this._event.latitude,this._event.longitude],this.options.initialZoomLevel)}else this.options.keepCurrentZoomLevel?
(a=this.options.flyTo?this._map.flyTo:this._map.panTo,a.bind(this._map)([this._event.latitude,this._event.longitude])):(a=this.options.flyTo?this._map.flyToBounds:this._map.fitBounds,this._ignoreEvent=!0,a.bind(this._map)(this.options.getLocationBounds(this._event),{padding:this.options.circlePadding,maxZoom:this.options.locateOptions.maxZoom}),c.Util.requestAnimFrame(function(){this._ignoreEvent=!1},this))},_drawCompass:function(){if(this._event){var a=this._event.latlng;if(this.options.showCompass&&
a&&null!==this._compassHeading){var b=this._isFollowing()?this.options.followCompassStyle:this.options.compassStyle;this._compass?(this._compass.setLatLng(a),this._compass.setHeading(this._compassHeading),this._compass.setStyle&&this._compass.setStyle(b)):this._compass=(new this.options.compassClass(a,this._compassHeading,b)).addTo(this._layer)}!this._compass||this.options.showCompass&&null!==this._compassHeading||(this._compass.removeFrom(this._layer),this._compass=null)}},_drawMarker:function(){function a(){return"string"===
typeof e?c.Util.template(e,{distance:g,unit:h}):"function"===typeof e?e({distance:g,unit:h}):e}void 0===this._event.accuracy&&(this._event.accuracy=0);var b=this._event.accuracy,d=this._event.latlng;if(this.options.drawCircle){var f=this._isFollowing()?this.options.followCircleStyle:this.options.circleStyle;this._circle?this._circle.setLatLng(d).setRadius(b).setStyle(f):this._circle=c.circle(d,b,f).addTo(this._layer)}if(this.options.metric){var g=b.toFixed(0);var h=this.options.strings.metersUnit}else g=
(3.2808399*b).toFixed(0),h=this.options.strings.feetUnit;this.options.drawMarker&&(b=this._isFollowing()?this.options.followMarkerStyle:this.options.markerStyle,this._marker?(this._marker.setLatLng(d),this._marker.setStyle&&this._marker.setStyle(b)):this._marker=(new this.options.markerClass(d,b)).addTo(this._layer));this._drawCompass();var e=this.options.strings.popup;this.options.showPopup&&e&&this._marker&&this._marker.bindPopup(a())._popup.setLatLng(d);this.options.showPopup&&e&&this._compass&&
this._compass.bindPopup(a())._popup.setLatLng(d)},_removeMarker:function(){this._layer.clearLayers();this._circle=this._marker=void 0},_unload:function(){this.stop();this._map.off("unload",this._unload,this)},_setCompassHeading:function(a){!isNaN(parseFloat(a))&&isFinite(a)?(this._compassHeading=a=Math.round(a),c.Util.requestAnimFrame(this._drawCompass,this)):this._compassHeading=null},_onCompassNeedsCalibration:function(){this._setCompassHeading()},_onDeviceOrientation:function(a){this._active&&
(a.webkitCompassHeading?this._setCompassHeading(a.webkitCompassHeading):a.absolute&&a.alpha&&this._setCompassHeading(360-a.alpha))},_onLocationError:function(a){3==a.code&&this.options.locateOptions.watch||(this.stop(),this.options.onLocationError(a,this))},_onLocationFound:function(a){if((!this._event||this._event.latlng.lat!==a.latlng.lat||this._event.latlng.lng!==a.latlng.lng||this._event.accuracy!==a.accuracy)&&this._active){this._event=a;this._drawMarker();this._updateContainerStyle();switch(this.options.setView){case "once":this._justClicked&&
this.setView();break;case "untilPan":this._userPanned||this.setView();break;case "untilPanOrZoom":this._userPanned||this._userZoomed||this.setView();break;case "always":this.setView()}this._justClicked=!1}},_onDrag:function(){this._event&&!this._ignoreEvent&&(this._userPanned=!0,this._updateContainerStyle(),this._drawMarker())},_onZoom:function(){this._event&&!this._ignoreEvent&&(this._userZoomed=!0,this._updateContainerStyle(),this._drawMarker())},_onZoomEnd:function(){this._event&&this._drawCompass();
this._event&&!this._ignoreEvent&&this._marker&&!this._map.getBounds().pad(-.3).contains(this._marker.getLatLng())&&(this._userPanned=!0,this._updateContainerStyle(),this._drawMarker())},_isFollowing:function(){if(!this._active)return!1;if("always"===this.options.setView)return!0;if("untilPan"===this.options.setView)return!this._userPanned;if("untilPanOrZoom"===this.options.setView)return!this._userPanned&&!this._userZoomed},_isOutsideMapBounds:function(){return void 0===this._event?!1:this._map.options.maxBounds&&
!this._map.options.maxBounds.contains(this._event.latlng)},_updateContainerStyle:function(){this._container&&(this._active&&!this._event?this._setClasses("requesting"):this._isFollowing()?this._setClasses("following"):this._active?this._setClasses("active"):this._cleanClasses())},_setClasses:function(a){"requesting"==a?(e(this._container,"active following"),h(this._container,"requesting"),e(this._icon,this.options.icon),h(this._icon,this.options.iconLoading)):"active"==a?(e(this._container,"requesting following"),
h(this._container,"active"),e(this._icon,this.options.iconLoading),h(this._icon,this.options.icon)):"following"==a&&(e(this._container,"requesting"),h(this._container,"active following"),e(this._icon,this.options.iconLoading),h(this._icon,this.options.icon))},_cleanClasses:function(){c.DomUtil.removeClass(this._container,"requesting");c.DomUtil.removeClass(this._container,"active");c.DomUtil.removeClass(this._container,"following");e(this._icon,this.options.iconLoading);h(this._icon,this.options.icon)},
_resetVariables:function(){this._userZoomed=this._userPanned=this._justClicked=this._active=!1}});c.control.locate=function(a){return new c.Control.Locate(a)};return k},window);