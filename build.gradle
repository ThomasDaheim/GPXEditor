// support for javafx11 - see https://openjfx.io/openjfx-docs/#gradle
buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'com.google.gradle:osdetector-gradle-plugin:1.6.0'
    }
}

apply plugin: 'java'
apply plugin: 'application'
apply plugin: 'com.google.osdetector'

// see https://github.com/kelemen/netbeans-gradle-project/issues/179
apply plugin: 'idea'
idea.module.downloadJavadoc = true

ext.platform = osdetector.os == 'osx' ? 'mac' : osdetector.os == 'windows' ? 'win' : osdetector.os

[compileJava, compileTestJava]*.options*.encoding = 'UTF-8'

// NetBeans will automatically add "run" and "debug" tasks relying on the
// "mainClass" property. You may however define the property prior executing
// tasks by passing a "-PmainClass=<QUALIFIED_CLASS_NAME>" argument.
//
// Note however, that you may define your own "run" and "debug" task if you
// prefer. In this case NetBeans will not add these tasks but you may rely on
// your own implementation.
if (!hasProperty('mainClass')) {
    ext.mainClass = 'tf.gpx.edit.main.GPXEditorManager'
}
mainClassName = 'tf.gpx.edit.main.GPXEditorManager'
def appName='GPXEditor'
group='tf.GPXEditor'
version='4.6'

repositories {
    mavenLocal()
    mavenCentral()
    jcenter()
    // You may define additional repositories, or even remove "mavenCentral()".
    // Read more about repositories here:
    //   http://www.gradle.org/docs/current/userguide/dependency_management.html#sec:repositories
    maven {
        url "http://maven.jzy3d.org/releases"
    }
}

dependencies {
    // JavaFX11 explicit dependencies
//    def javafx_version='11.0.2'
    def javafx_version='14'
    compile "org.openjfx:javafx-base:$javafx_version:$platform"
    compile "org.openjfx:javafx-graphics:$javafx_version:$platform"
    compile "org.openjfx:javafx-controls:$javafx_version:$platform"
    compile "org.openjfx:javafx-fxml:$javafx_version:$platform"
    compile "org.openjfx:javafx-swing:$javafx_version:$platform"
    compile "org.openjfx:javafx-web:$javafx_version:$platform"
    compile "org.openjfx:javafx-media:$javafx_version:$platform"
    
    // TFE, 20191209: our own helper library
    compile 'tf.JavaHelper:JavaHelper:1.1'

    // The production code uses the SLF4J logging API at compile time
    compile 'org.slf4j:slf4j-api:1.7.12'
    compile 'commons-cli:commons-cli:1.4'
    compile 'commons-io:commons-io:2.6'
    compile 'org.apache.commons:commons-lang3:3.9'
    compile 'org.apache.commons:commons-collections4:4.4'
    compile group: 'org.apache.commons', name: 'commons-text', version: '1.7'
    compile group: 'org.apache.commons', name: 'commons-math3', version: '3.6.1'
    compile group: 'org.apache.commons', name: 'commons-csv', version: '1.7'
    compile 'gpx-parser:gpx-parser:1.2'
    compile 'org.jzy3d:jzy3d-api:1.0.2'
    compile 'org.jzy3d:jzy3d-javafx:1.0.2'
    compile group: 'org.controlsfx', name: 'controlsfx', version: '11.0.1'
    compile 'de.jensd:fontawesomefx:8.9'
    compile 'de.saring:leafletmap:1.0.5-SNAPSHOT'
    compile 'com.fasterxml.jackson.core:jackson-core:2.9.9'
    compile 'com.fasterxml.jackson.core:jackson-databind:2.9.9.3'
    compile group: 'org.jfxtras', name: 'jfxtras-controls', version: '10.0-r1'
    compile group: 'org.jfxtras', name: 'jfxtras-labs', version: '9.0-r1'
    compile 'uk.com.robust-it:cloning:1.9.12'
    
    testCompile group: 'org.junit.jupiter', name: 'junit-jupiter-api', version: '5.6.1'
}

compileJava {
    doFirst {
        options.compilerArgs = [
                '--module-path', classpath.asPath,
                '--add-modules', 'javafx.controls,javafx.graphics,javafx.base,javafx.fxml,javafx.web,javafx.swing,javafx.media',
                '-Xlint:unchecked',
                '-Xlint:deprecation',
        ]
    }
}

// see https://github.com/kelemen/netbeans-gradle-project/issues/403 on how to extend gradle tasks
def newArgs = [ '--add-modules', 'javafx.controls,javafx.graphics,javafx.base,javafx.fxml,javafx.web,javafx.swing,javafx.media',
                // various exports needed at run time - see https://stackoverflow.com/a/52142071
                '--add-exports', 'javafx.graphics/com.sun.javafx.util=ALL-UNNAMED',
                '--add-exports', 'javafx.base/com.sun.javafx.reflect=ALL-UNNAMED',
                '--add-exports', 'javafx.base/com.sun.javafx.beans=ALL-UNNAMED',
                '--add-exports', 'javafx.base/com.sun.javafx.logging=ALL-UNNAMED',
                '--add-exports', 'javafx.base/com.sun.javafx.runtime=ALL-UNNAMED',
                '--add-exports', 'javafx.base/com.sun.javafx.collections=ALL-UNNAMED',
                '--add-exports', 'javafx.base/com.sun.javafx.event=ALL-UNNAMED',
                '--add-exports', 'javafx.graphics/com.sun.prism=ALL-UNNAMED',
                '--add-exports', 'javafx.graphics/com.sun.javafx.sg.prism=ALL-UNNAMED',
                '--add-exports', 'javafx.graphics/com.sun.javafx.scene=ALL-UNNAMED',
                '--add-exports', 'javafx.media/com.sun.media.jfxmedia=ALL-UNNAMED',
                '--add-exports', 'javafx.media/com.sun.media.jfxmedia.events=ALL-UNNAMED',
                '--add-exports', 'javafx.controls/com.sun.javafx.scene.control=ALL-UNNAMED',
                '--add-exports', 'javafx.controls/com.sun.javafx.scene.control.behavior=ALL-UNNAMED',
                '--add-exports', 'javafx.controls/com.sun.javafx.scene.control.inputmap=ALL-UNNAMED',
                '--add-exports', 'javafx.controls/com.sun.javafx.charts=ALL-UNNAMED',
                '--add-exports', 'javafx.graphics/com.sun.javafx.scene.traversal=ALL-UNNAMED',
    ]
    
// extend Netbeans Gradle "Run" task
run {
    doFirst {
        jvmArgs = jvmArgs.plus(['--module-path', classpath.asPath,])
        jvmArgs = jvmArgs.plus(newArgs)
        jvmArgs = jvmArgs.plus('-Xss80M')
        jvmArgs = jvmArgs.plus('-Xmx4096M')
    }
}

test {
    // https://stackoverflow.com/a/35467005
    testLogging.showStandardStreams true;   
}

// extend Netbeans Gradle "Debug" task
task(debug, dependsOn: 'classes', type: JavaExec) {
    doFirst {
        main = 'tf.gpx.edit.main.GPXEditorManager'
        classpath = sourceSets.main.runtimeClasspath
        jvmArgs = jvmArgs.plus([
                '--module-path', classpath.asPath,
                "-Xdebug",
                "-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005",
        ])
        jvmArgs = jvmArgs.plus(newArgs)
        jvmArgs = jvmArgs.plus('-Xss80M')
        jvmArgs = jvmArgs.plus('-Xmx4096M')
    }
}

jar {
    manifest {
        attributes(
            'Built-By'       : System.properties['user.name'],
            'Build-Timestamp': new java.text.SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ").format(new Date()),
            'Created-By'     : "Gradle ${gradle.gradleVersion}",
            'Build-Jdk'      : "${System.properties['java.version']} (${System.properties['java.vendor']} ${System.properties['java.vm.version']})",
            'Build-OS'       : "${System.properties['os.name']} ${System.properties['os.arch']} ${System.properties['os.version']}",
            'App-Name'       : appName,
            'App-Version'    : version,
            'App-URL'        : "https://github.com/ThomasDaheim/GPXEditor"
        )
    }
}
